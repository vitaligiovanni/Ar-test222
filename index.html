<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>WebAR –í–∏–¥–µ–æ –Ω–∞ —Ñ–æ—Ç–æ</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #debug {
        position: absolute;
        top: 5px;
        left: 5px;
        width: 95%;
        max-height: 40%;
        background: rgba(0,0,0,0.6);
        color: #0f0;
        font: 12px monospace;
        padding: 5px;
        overflow-y: auto;
        white-space: pre-wrap;
      }
      #startButton {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        background: #007bff;
        color: #fff;
        border: none;
        border-radius: 8px;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="debug">Debug log:</div>
    <button id="startButton">‚ñ∂ Start AR (–Ω–∞–∂–º–∏ –∏ —Ä–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É)</button>

    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind;"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights, alpha: true"
      vr-mode-ui="enabled: false"
      embedded
      loading-screen="enabled: false"
    >
      <a-assets>
        <video id="videoAsset" src="./BoudoirPhotoBox.mp4"
               preload="auto" loop playsinline
               webkit-playsinline crossorigin="anonymous" muted></video>
      </a-assets>

      <a-camera position="0 0 0" look-controls="false"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        <a-plane id="videoPlane"
                 src="#videoAsset"
                 width="1.6" height="0.9"
                 position="0 0 0"
                 rotation="0 0 0"
                 material="shader: flat; transparent: true; opacity: 0; side: double">
        </a-plane>
      </a-entity>
    </a-scene>

    <script>
      const dbg = msg => {
        console.log(msg);
        document.getElementById("debug").innerText += "\n¬ª " + msg;
      };

      const videoAsset = document.getElementById("videoAsset");
      const videoPlane = document.getElementById("videoPlane");
      const startButton = document.getElementById("startButton");
      const sceneEl = document.querySelector("a-scene");

      // –î–æ–±–∞–≤–∏–º –Ω–æ–≤—ã–π —Ñ–ª–∞–≥ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
      let videoPlaying = false;

      function playVideo() {
        if (!videoPlaying) {
          // –í–∫–ª—é—á–∞–µ–º –∑–≤—É–∫, –µ—Å–ª–∏ —ç—Ç–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ, –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–∏–¥–µ–æ
          videoAsset.muted = false;
          videoAsset.play().then(() => {
            dbg("‚ñ∂Ô∏è –í–∏–¥–µ–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è.");
            videoPlaying = true;
          }).catch(e => {
            dbg("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –≤–∏–¥–µ–æ: " + e);
          });

          // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –≤–∏–¥–µ–æ
          let op = 0;
          const step = 0.05;
          const int = setInterval(() => {
            op += step;
            if (op >= 1) {
              op = 1;
              clearInterval(int);
            }
            videoPlane.setAttribute("material", `opacity: ${op}; transparent: true; shader: flat; side: double;`);
          }, 50);
        }
      }

      function stopVideo() {
        if (videoPlaying) {
          // –ü–ª–∞–≤–Ω–æ–µ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –≤–∏–¥–µ–æ
          let op = 1;
          const step = 0.05;
          const int = setInterval(() => {
            op -= step;
            if (op <= 0) {
              op = 0;
              clearInterval(int);
              videoAsset.pause(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ, –∫–æ–≥–¥–∞ –æ–Ω–æ –∏—Å—á–µ–∑–ª–æ
              videoAsset.currentTime = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤–∏–¥–µ–æ –Ω–∞ –Ω–∞—á–∞–ª–æ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ–∫–∞–∑–∞
              videoPlaying = false;
            }
            videoPlane.setAttribute("material", `opacity: ${op}; transparent: true; shader: flat; side: double;`);
          }, 50);
        }
      }

      startButton.addEventListener("click", () => {
        startButton.style.display = "none";
        dbg("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª '–°—Ç–∞—Ä—Ç'");
        // MindAR –¥–æ–ª–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è. –ù–∞–º –Ω–µ –Ω—É–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å `start()` –≤—Ä—É—á–Ω—É—é.
      });

      sceneEl.addEventListener("arReady", () => dbg("‚úÖ AR –≥–æ—Ç–æ–≤"));
      
      sceneEl.addEventListener("targetFound", () => {
        dbg("üéØ –ú–∞—Ä–∫–µ—Ä –æ–±–Ω–∞—Ä—É–∂–µ–Ω");
        playVideo();
      });

      sceneEl.addEventListener("targetLost", () => {
        dbg("‚≠ï –ú–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω");
        stopVideo();
      });
    </script>
  </body>
</html>

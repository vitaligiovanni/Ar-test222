<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AR Video Overlay</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {height: 100%; margin: 0; background: #000; color: #fff;}
    #ui {position: fixed; left: 10px; top: 10px; z-index: 9999; display: flex; gap: 8px; flex-wrap: wrap;}
    button {padding: 10px 14px; border-radius: 8px; border: none; background: #00b050; color: #fff; font-weight: 700; cursor: pointer;}
    button.warn {background: #ff7a00;}
    #debug {position: fixed; left: 10px; bottom: 10px; right: 10px; max-height: 35vh; overflow: auto; background: rgba(0,0,0,0.6); padding: 10px; border-radius: 8px; font-size: 13px;}
    #camPreview {position: fixed; inset: 0; width: 100%; height: 100%; object-fit: cover; z-index: 0; display: none;}
    #loadingOverlay {position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 5; background: rgba(0,0,0,0.7); font-size: 18px; padding: 20px;}
    #unmuteBtn {background: #1a73e8;}
    .a-enter-vr, .a-enter-ar {display: none !important;}
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn">‚ñ∂ Start AR</button>
    <button id="testCamBtn" class="warn">–¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã</button>
    <button id="unmuteBtn" style="display:none;">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
    <div id="status" style="margin-left:8px;font-weight:600">Status: –æ–∂–∏–¥–∞–Ω–∏–µ</div>
  </div>

  <video id="camPreview" autoplay playsinline muted></video>
  <div id="loadingOverlay" style="display:none">–ó–∞–≥—Ä—É–∑–∫–∞ AR...</div>

  <a-scene id="arScene"
           embedded
           mindar-image="imageTargetSrc: ./targets.mind;"
           vr-mode-ui="enabled: false"
           loading-screen="enabled: false"
           renderer="colorManagement: true, physicallyCorrectLights, alpha: true">
    <a-assets>
      <video id="videoAsset" src="./BoudoirPhotoBox.mp4" preload="auto" loop playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0"></a-camera>

    <!-- –í–ê–ñ–ù–û: –≤–∏–¥–µ–æ-–ø–ª–æ—Å–∫–æ—Å—Ç—å –≤–Ω—É—Ç—Ä–∏ target -->
    <a-entity id="targetEntity" mindar-image-target="targetIndex: 0">
      <a-plane id="videoPlane"
               src="#videoAsset"
               position="0 0 0"
               rotation="0 0 0"
               material="shader: flat; transparent: true; opacity: 0">
      </a-plane>
    </a-entity>
  </a-scene>

  <div id="debug"><b>debug log</b><br></div>

  <script>
    const dbg = (m)=>{console.log(m);document.getElementById('debug').innerHTML+=`<div>¬ª ${m}</div>`;};
    const setStatus=(s)=>{document.getElementById('status').textContent='Status: '+s;};

    const videoAsset=document.getElementById('videoAsset');
    const videoPlane=document.getElementById('videoPlane');
    const startBtn=document.getElementById('startBtn');
    const testCamBtn=document.getElementById('testCamBtn');
    const unmuteBtn=document.getElementById('unmuteBtn');
    const camPreview=document.getElementById('camPreview');
    const loadingOverlay=document.getElementById('loadingOverlay');
    const arScene=document.getElementById('arScene');

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ –ø–ª–æ—Å–∫–æ—Å—Ç–∏ –ø–æ–¥ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω –≤–∏–¥–µ–æ
    videoAsset.addEventListener('loadedmetadata', ()=>{
      const w = videoAsset.videoWidth;
      const h = videoAsset.videoHeight;
      if (w && h) {
        const aspect = w/h;
        const baseHeight = 1.0; // —É—Å–ª–æ–≤–Ω–∞—è –≤—ã—Å–æ—Ç–∞
        const baseWidth = baseHeight * aspect;
        videoPlane.setAttribute('width', baseWidth);
        videoPlane.setAttribute('height', baseHeight);
        dbg(`–†–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ: ${w}x${h}, aspect=${aspect.toFixed(2)} ‚Üí plane ${baseWidth.toFixed(2)}x${baseHeight.toFixed(2)}`);
      }
    });

    async function startCameraPreview(){
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
      camPreview.srcObject=stream;
      camPreview.style.display='block';
      dbg('–ö–∞–º–µ—Ä–∞: –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∫–ª—é—á—ë–Ω');
      return stream;
    }

    async function startMindAR(){
      setStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR...');
      loadingOverlay.style.display='flex';

      const mindarSystem=arScene.systems['mindar-image-system'];
      if(mindarSystem&&mindarSystem.start) await mindarSystem.start();

      setStatus('AR –∑–∞–ø—É—â–µ–Ω ‚Äî –∂–¥—ë–º –º–∞—Ä–∫–µ—Ä');
      loadingOverlay.style.display='none';

      arScene.addEventListener('targetFound',()=>{dbg('–ú–∞—Ä–∫–µ—Ä –Ω–∞–π–¥–µ–Ω!');fadeInVideo();});
      arScene.addEventListener('targetLost',()=>{dbg('–ú–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω');pauseAndHide();});
    }

    async function fadeInVideo(){
      try{
        videoAsset.muted=false;
        await videoAsset.play().catch(()=>{unmuteBtn.style.display='inline-block';});
        unmuteBtn.style.display='none';

        let op=0;const step=0.05;
        const int=setInterval(()=>{op+=step;if(op>=1){op=1;clearInterval(int);}videoPlane.setAttribute('material','opacity:'+op);},50);
      }catch(e){dbg('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ: '+e);}
    }

    function pauseAndHide(){videoAsset.pause();videoPlane.setAttribute('material','opacity:0');}

    startBtn.onclick=async()=>{await startCameraPreview();await startMindAR();};
    testCamBtn.onclick=async()=>{await startCameraPreview();};
    unmuteBtn.onclick=async()=>{videoAsset.muted=false;await videoAsset.play();unmuteBtn.style.display='none';};
  </script>
</body>
</html>

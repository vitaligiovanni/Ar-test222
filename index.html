<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>AR photobook ‚Äî test</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: transparent;
      font-family: Arial, Helvetica, sans-serif;
      color: #fff;
      overflow: hidden;
    }
    a-scene, canvas {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background: transparent !important;
      z-index: 0;
    }
    #mindar-video {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1;
      pointer-events: none;
    }
    #ui {
      position: fixed;
      z-index: 9999;
      left: 12px;
      top: 12px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: 0;
      background: #1976d2;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    button.secondary {
      background: #00b050;
    }
    #status {
      margin-left: 8px;
      padding: 6px 8px;
      background: rgba(0,0,0,0.5);
      border-radius: 6px;
      font-weight: 600;
    }
    #debug {
      position: fixed;
      left: 12px;
      bottom: 12px;
      right: 12px;
      max-height: 34vh;
      overflow: auto;
      background: rgba(0,0,0,0.55);
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      line-height: 1.4;
    }
    .a-enter-vr, .a-enter-ar {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn">‚ñ∂ Start AR</button>
    <button id="unmuteBtn" style="display:none" class="secondary">üîä –í–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫</button>
    <div id="status">Status: –æ–∂–∏–¥–∞–Ω–∏–µ</div>
  </div>

  <a-scene id="scene"
           embedded
           mindar-image="imageTargetSrc: ./targets.mind; autoStart: false;"
           arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;"
           renderer="colorManagement: true, physicallyCorrectLights: true, alpha: true"
           vr-mode-ui="enabled: false"
           loading-screen="enabled: false">
    <a-assets>
      <video id="videoAsset" src="./BoudoirPhotoBox.mp4" preload="auto" loop playsinline webkit-playsinline muted crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

    <a-entity id="anchor0" mindar-image-target="targetIndex: 0">
      <a-plane id="videoPlane" src="#videoAsset"
               material="shader: flat; transparent: true; opacity: 0; side: double"
               rotation="0 0 0"></a-plane>
    </a-entity>
  </a-scene>

  <div id="debug"><b>debug</b><br></div>

<script>
  const logEl = document.getElementById('debug');
  function dbg(msg){ console.log(msg); logEl.innerHTML += `<div>¬ª ${msg}</div>`; logEl.scrollTop = logEl.scrollHeight; }
  const statusEl = document.getElementById('status');
  function status(s){ statusEl.innerText = 'Status: ' + s; dbg(s); }

  const startBtn = document.getElementById('startBtn');
  const unmuteBtn = document.getElementById('unmuteBtn');
  const sceneEl = document.getElementById('scene');
  const videoAsset = document.getElementById('videoAsset');
  const plane = document.getElementById('videoPlane');

  async function fileExists(url){
    try{
      const r = await fetch(url, { method: 'HEAD' });
      return r.ok;
    }catch(e){ return false; }
  }

  async function prepareCheck(){
    const t = await fileExists('./targets.mind');
    const v = await fileExists('./BoudoirPhotoBox.mp4');
    dbg(`targets.mind ${t ? 'FOUND' : 'MISSING'}`);
    dbg(`BoudoirPhotoBox.mp4 ${v ? 'FOUND' : 'MISSING'}`);
    if(!t) status('–û—à–∏–±–∫–∞: targets.mind –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–µ—Ä–µ–∏–º–µ–Ω—É–π targets (1).mind ‚Üí targets.mind');
    if(!v) status('–û—à–∏–±–∫–∞: BoudoirPhotoBox.mp4 –Ω–µ –Ω–∞–π–¥–µ–Ω.');
    return t && v;
  }

  videoAsset.addEventListener('loadedmetadata', () => {
    const w = videoAsset.videoWidth;
    const h = videoAsset.videoHeight;
    if(w && h){
      const baseH = 1.0;
      const baseW = (w / h) * baseH;
      plane.setAttribute('width', baseW);
      plane.setAttribute('height', baseH);
      dbg(`–ú–∞—Ç—á–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –ø–ª–æ—Å–∫–æ—Å—Ç–∏: video ${w}x${h} ‚Üí plane ${baseW.toFixed(3)} x ${baseH}`);
    } else dbg('video metadata –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç');
  });

  function fadeTo(op, duration=400){
    const start = parseFloat(plane.getAttribute('material').opacity || 0);
    const steps = Math.max(8, Math.round(duration / 40));
    let i = 0;
    const delta = (op - start) / steps;
    const id = setInterval(()=>{
      i++;
      const cur = start + delta * i;
      plane.setAttribute('material', `shader: flat; transparent: true; opacity: ${Math.max(0,Math.min(1,cur))}; side: double`);
      if(i >= steps) clearInterval(id);
    }, 40);
  }

  async function startAR(){
    startBtn.disabled = true;
    status('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤...');
    const ok = await prepareCheck();
    if(!ok){ startBtn.disabled = false; return; }

    try{
      status('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ –∫–∞–º–µ—Ä—É...');
      const system = sceneEl.systems['mindar-image-system'];
      if(!system){
        dbg('–û—à–∏–±–∫–∞: mindar-image-system –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –≤ —Å—Ü–µ–Ω–µ');
        status('–û—à–∏–±–∫–∞ init: mindar system missing');
        startBtn.disabled = false;
        return;
      }
      await system.start();
      status('AR –∑–∞–ø—É—â–µ–Ω ‚Äî –∫–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞');
      dbg('system.start() –≤—ã–ø–æ–ª–Ω–µ–Ω');

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞
      const video = document.querySelector('video:not(#videoAsset)');
      if(video && video.srcObject){
        video.id = 'mindar-video';
        video.style.position = 'fixed';
        video.style.inset = '0';
        video.style.width = '100%';
        video.style.height = '100%';
        video.style.objectFit = 'cover';
        video.style.zIndex = '-1';
        video.style.pointerEvents = 'none';
        dbg(`–í–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã –∞–∫—Ç–∏–≤–µ–Ω. –†–∞–∑–º–µ—Ä: ${video.videoWidth}x${video.videoHeight}`);
      } else {
        dbg('–û—à–∏–±–∫–∞: –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω');
        // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏–¥–µ–æ—ç–ª–µ–º–µ–Ω—Ç–∞
        const fallbackVideo = document.createElement('video');
        fallbackVideo.id = 'mindar-video';
        fallbackVideo.playsInline = true;
        fallbackVideo.style.position = 'fixed';
        fallbackVideo.style.inset = '0';
        fallbackVideo.style.width = '100%';
        fallbackVideo.style.height = '100%';
        fallbackVideo.style.objectFit = 'cover';
        fallbackVideo.style.zIndex = '-1';
        document.body.appendChild(fallbackVideo);
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
          fallbackVideo.srcObject = stream;
          fallbackVideo.play();
          dbg('–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å–æ–∑–¥–∞–Ω –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã');
        } catch(e) {
          dbg('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫–∞: ' + e);
        }
      }

      sceneEl.addEventListener('arReady', () => dbg('arReady'));
      sceneEl.addEventListener('targetFound', (ev) => {
        dbg('targetFound');
        videoAsset.muted = true;
        videoAsset.currentTime = 0;
        videoAsset.play().catch(e => dbg('video.play() rejected: ' + e));
        fadeTo(1, 300);
        unmuteBtn.style.display = 'inline-block';
      });
      sceneEl.addEventListener('targetLost', () => {
        dbg('targetLost');
        videoAsset.pause();
        fadeTo(0, 200);
      });

      window.addEventListener('error', (e) => dbg('window.error: '+ e.message));
      window.addEventListener('unhandledrejection', (e) => dbg('unhandledrejection: '+ (e.reason?.message || e.reason)));

    }catch(err){
      dbg('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ AR: ' + (err?.message || err));
      status('–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ AR ‚Äî —Å–º. debug');
      startBtn.disabled = false;
    }
  }

  startBtn.addEventListener('click', startAR);

  unmuteBtn.addEventListener('click', async ()=>{
    try{
      videoAsset.muted = false;
      await videoAsset.play();
      dbg('–ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω');
      unmuteBtn.style.display = 'none';
    }catch(e){ dbg('–ù–µ —É–¥–∞–ª–æ—Å—å –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫: '+ e); }
  });

  dbg('–ì–æ—Ç–æ–≤–æ: –Ω–∞–∂–º–∏—Ç–µ Start AR. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ targets.mind –∏ BoudoirPhotoBox.mp4 –ª–µ–∂–∞—Ç —Ä—è–¥–æ–º —Å index.html –∏ —á—Ç–æ —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ HTTPS.');
</script>
</body>
</html>

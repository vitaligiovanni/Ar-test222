<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>AR Debug / Boudoir</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: #000;
      font-family: Arial, Helvetica, sans-serif;
      color: #fff;
    }
    #ui {
      position: fixed;
      left: 10px;
      top: 10px;
      z-index: 9999;
      width: calc(100% - 20px);
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 14px;
      border-radius: 8px;
      border: none;
      background: #00b050;
      color: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    button.warn { background: #ff7a00; }
    #debug {
      position: fixed;
      left: 10px;
      bottom: 10px;
      right: 10px;
      max-height: 35vh;
      overflow: auto;
      background: rgba(0, 0, 0, 0.6);
      padding: 10px;
      border-radius: 8px;
      font-size: 13px;
      border: 1px solid rgba(255, 255, 255, 0.06);
    }
    #camPreview {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
      display: none;
    }
    #loadingOverlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      background: rgba(0, 0, 0, 0.7);
      font-size: 18px;
      padding: 20px;
      text-align: center;
    }
    .a-enter-vr, .a-enter-ar {
      display: none !important;
    }
  </style>
</head>
<body>
  <div id="ui">
    <button id="startBtn">‚ñ∂ Start AR (–Ω–∞–∂–º–∏ –∏ —Ä–∞–∑—Ä–µ—à–∏ –∫–∞–º–µ—Ä—É)</button>
    <button id="testCamBtn" class="warn">–¢–µ—Å—Ç –∫–∞–º–µ—Ä—ã</button>
    <div id="status" style="margin-left:8px; font-weight:600">Status: –æ–∂–∏–¥–∞–Ω–∏–µ</div>
  </div>

  <video id="camPreview" autoplay playsinline muted></video>
  <div id="loadingOverlay" style="display:none">–ó–∞–≥—Ä—É–∑–∫–∞ AR... –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–ø—Ä–æ—Å–∞ –∫–∞–º–µ—Ä—ã –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø</div>

  <a-scene id="arScene"
           embedded
           vr-mode-ui="enabled: false"
           loading-screen="enabled: false"
           renderer="colorManagement: true, physicallyCorrectLights, alpha: true">
    <a-assets>
      <video id="videoAsset" src="./BoudoirPhotoBox.mp4" preload="auto" loop playsinline webkit-playsinline crossorigin="anonymous"></video>
    </a-assets>

    <a-camera position="0 0 0"></a-camera>

    <!-- üëá –ò–∑–º–µ–Ω–µ–Ω–æ: position="0 0 0.01" –∏ rotation="-90 0 0" -->
    <a-entity id="targetEntity" mindar-image-target="targetIndex: 0">
      <a-plane id="videoPlane" src="#videoAsset" width="1.6" height="0.9"
               position="0 0 0.01" rotation="-90 0 0"
               material="shader: flat; transparent: true; opacity: 0"></a-plane>
    </a-entity>
  </a-scene>

  <div id="debug"><b>debug log</b><br></div>

  <script>
    const dbg = (msg) => {
      console.log(msg);
      const debug = document.getElementById('debug');
      debug.innerHTML += ('<div style="margin-top:6px">¬ª ' + msg + '</div>');
      debug.scrollTop = debug.scrollHeight;
    };
    const setStatus = (s) => {
      document.getElementById('status').textContent = 'Status: ' + s;
    };

    const TARGET_FILENAME = './targets.mind';
    const ALT_TARGET_FILENAME = './targets(1).mind';
    const VIDEO_FILENAME = './BoudoirPhotoBox.mp4';

    const startBtn = document.getElementById('startBtn');
    const testCamBtn = document.getElementById('testCamBtn');
    const camPreview = document.getElementById('camPreview');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const videoAsset = document.getElementById('videoAsset');
    const arScene = document.getElementById('arScene');
    const videoPlane = document.getElementById('videoPlane');

    async function checkFile(url) {
      try {
        const res = await fetch(url, { method: 'HEAD' });
        return res.ok;
      } catch (e) {
        return false;
      }
    }

    async function prepare() {
      dbg('–ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ñ–∞–π–ª–æ–≤...');
      const t1 = await checkFile(TARGET_FILENAME);
      dbg(`targets.mind –¥–æ—Å—Ç—É–ø–µ–Ω: ${t1}`);
      let targetToUse = TARGET_FILENAME;
      if (!t1) {
        const t2 = await checkFile(ALT_TARGET_FILENAME);
        dbg(`targets(1).mind –¥–æ—Å—Ç—É–ø–µ–Ω: ${t2}`);
        if (t2) targetToUse = ALT_TARGET_FILENAME;
        else dbg('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω targets.mind');
      }
      const v = await checkFile(VIDEO_FILENAME);
      dbg(`–í–∏–¥–µ–æ ${VIDEO_FILENAME} –¥–æ—Å—Ç—É–ø–Ω–æ: ${v}`);
      return { targetToUse, ok: ((t1 || await checkFile(ALT_TARGET_FILENAME)) && v) };
    }

    async function startCameraPreview() {
      try {
        dbg('–ó–∞–ø—Ä–æ—Å –∫–∞–º–µ—Ä—ã...');
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
        camPreview.srcObject = stream;
        camPreview.style.display = 'block';
        dbg('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞');
        return stream;
      } catch (e) {
        dbg('–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: ' + e.message);
        throw e;
      }
    }

    async function startMindAR(targetFile) {
      setStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AR...');
      loadingOverlay.style.display = 'flex';
      arScene.setAttribute('mindar-image', `imageTargetSrc: ${targetFile};`);
      await new Promise(r => setTimeout(r, 500));
      const mindarSystem = arScene?.systems?.['mindar-image-system'];
      await mindarSystem?.start();
      loadingOverlay.style.display = 'none';
      setStatus('AR –∑–∞–ø—É—â–µ–Ω ‚Äî –∂–¥—ë–º –º–∞—Ä–∫–µ—Ä');

      arScene.addEventListener('targetFound', () => {
        dbg('üìç –ú–∞—Ä–∫–µ—Ä –Ω–∞–π–¥–µ–Ω');
        fadeInVideo();
      });
      arScene.addEventListener('targetLost', () => {
        dbg('‚ùå –ú–∞—Ä–∫–µ—Ä –ø–æ—Ç–µ—Ä—è–Ω');
        pauseAndHide();
      });
    }

    async function fadeInVideo() {
      try {
        videoAsset.muted = false;
        await videoAsset.play().catch(e => dbg('üîá –í–∏–¥–µ–æ –±–µ–∑ –∑–≤—É–∫–∞: ' + e));
        videoPlane.setAttribute('opacity', 0);
        let op = 0;
        const step = 0.05;
        const int = setInterval(() => {
          op += step;
          if (op >= 1) {
            op = 1;
            clearInterval(int);
          }
          videoPlane.setAttribute('opacity', op);
        }, 50);
      } catch (e) {
        dbg('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ: ' + e.message);
      }
    }

    function pauseAndHide() {
      try { videoAsset.pause(); } catch (e) {}
      videoPlane.setAttribute('opacity', 0);
    }

    startBtn.addEventListener('click', async () => {
      startBtn.disabled = true;
      const prep = await prepare();
      if (!prep.ok) {
        dbg('–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.');
        startBtn.disabled = false;
        return;
      }
      try {
        await startCameraPreview();
      } catch (e) {
        startBtn.disabled = false;
        return;
      }
      setTimeout(() => {
        startMindAR(prep.targetToUse);
      }, 600);
    });

    testCamBtn.addEventListener('click', async () => {
      testCamBtn.disabled = true;
      try {
        await startCameraPreview();
        setStatus('–ö–∞–º–µ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤–∫–ª—é—á–µ–Ω');
      } catch (e) {
        dbg('–û—à–∏–±–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ' + e.message);
      } finally {
        testCamBtn.disabled = false;
      }
    });

    dbg('üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—Å–µ —Ñ–∞–π–ª—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ HTTPS (GitHub Pages)');
  </script>
</body>
</html>
